---
title: "å®Œæˆã—ãŸMakefileã®ç´¹ä»‹"
---
### å®Œæˆã—ãŸMakefileã®ç´¹ä»‹

---

å‰ç« ã§ã¯Makefileã®æœ€é©åŒ–ã®ã‚³ãƒ„ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã—ãŸã€‚ã“ã®ç« ã§ã¯ã€ãã®çµæœã¨ã—ã¦å®Œæˆã—ãŸMakefileã«ã¤ã„ã¦è©³ã—ãè§£èª¬ã—ã¾ã™ã€‚

#### Makefileã®æ¦‚è¦

ã“ã®Makefileã¯ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒªãƒªãƒ¼ã‚¹ä½œæ¥­ã‚’è‡ªå‹•åŒ–ã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã™ã€‚å…·ä½“çš„ã«ã¯ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ç”Ÿæˆã€CHANGELOGã®æ›´æ–°ã€ã‚³ãƒŸãƒƒãƒˆã®ä½œæˆã€ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ä½œæˆã¨ãƒãƒ¼ã‚¸ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¿ã‚°ã®ä»˜ä¸ã€ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®å…¬é–‹ã€æ–°ã—ã„é–‹ç™ºãƒ–ãƒ©ãƒ³ãƒã®ä½œæˆã¨ã„ã£ãŸä¸€é€£ã®ä½œæ¥­ã‚’è‡ªå‹•ã§è¡Œã„ã¾ã™ã€‚

> å®Ÿè¡Œå‰ã«`pyproject.toml`ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ‰‹å‹•ã§æ›´æ–°ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®éƒ¨åˆ†ã¯ **rye** ã®æ©Ÿèƒ½ã«ã‚ˆã‚Šè‡ªå‹•ã§æ›´æ–°ã™ã‚‹æ–¹æ³•ã‚‚ã‚ã‚‹ã®ã§ã™ãŒã€è¨˜äº‹ä½œæˆæ™‚ã«ã¯ä¸å…·åˆãŒã‚ã‚Šã€æ‰‹å‹•ã§è¡Œã†ã“ã¨ã«ã—ã¦ã„ã¾ã™ã€‚

#### ä¸»è¦ãªã‚¿ãƒ¼ã‚²ãƒƒãƒˆ

- `release-step1`: ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆã™ã‚‹ã¾ã§ã®ä¸€é€£ã®ä½œæ¥­ã‚’è¡Œã„ã¾ã™ã€‚
- `release-step2`: ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒãƒ¼ã‚¸ã—ã€ãã®å¾Œã®ä¸€é€£ã®ä½œæ¥­ã‚’è¡Œã„ã¾ã™ã€‚

#### è£œåŠ©çš„ãªã‚¿ãƒ¼ã‚²ãƒƒãƒˆ

- `gen-docs`: pdocã‚’ä½¿ç”¨ã—ã¦ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆã—ã¾ã™ã€‚
- `gen-changelog`: git cliffã‚’ä½¿ç”¨ã—ã¦CHANGELOGã‚’ç”Ÿæˆã—ã¾ã™ã€‚
- `commit`: å…¨ã¦ã®å¤‰æ›´ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã—ã€ã‚³ãƒŸãƒƒãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚
- `create-pr`: GitHub CLIï¼ˆghï¼‰ã‚’ä½¿ç”¨ã—ã¦ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚
- `merge-pr`: ä½œæˆã—ãŸãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒãƒ¼ã‚¸ã—ã¾ã™ã€‚
- `pull-main`: mainãƒ–ãƒ©ãƒ³ãƒã«åˆ‡ã‚Šæ›¿ãˆã€æœ€æ–°ã®å¤‰æ›´ã‚’ãƒ—ãƒ«ã—ã¾ã™ã€‚
- `tag-version`: æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚¿ã‚°ã‚’ä»˜ã‘ã¾ã™ã€‚
- `publish`: ryeã‚’ä½¿ç”¨ã—ã¦ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ã—ã€å…¬é–‹ã—ã¾ã™ã€‚
- `create-dev-branch`: æ–°ã—ã„é–‹ç™ºãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆã—ã¾ã™ã€‚

#### ä½¿ã„æ–¹ã®ç¢ºèª

`make help` ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€Makefileã®ç°¡å˜ãªä½¿ã„æ–¹ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€æ–°ã—ã„ãƒ¡ãƒ³ãƒãƒ¼ã§ã‚‚ã‚¹ãƒ ãƒ¼ã‚ºã«ä½œæ¥­ã‚’é–‹å§‹ã§ãã¾ã™ã€‚

```bash
make help
```

#### è£œè¶³è§£èª¬

##### `NEW_VERSION`ã®å½¢å¼

`rye version` ã‚³ãƒãƒ³ãƒ‰ã¯ã€`0.5.0` ã®ã‚ˆã†ãªå½¢å¼ã§ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’å‡ºåŠ›ã—ã¾ã™ã€‚ã—ã‹ã—ã€å¤šãã®å ´åˆã€Gitã®ã‚¿ã‚°ã¨ã—ã¦ã¯ `v0.5.0` ã®ã‚ˆã†ã«æ¥é ­è¾ `v` ãŒä»˜ã„ãŸå½¢å¼ãŒä¸€èˆ¬çš„ã§ã™ã€‚ã“ã®Makefileã§ã¯ã€ãã®ã‚ˆã†ãªå½¢å¼ã«åˆã‚ã›ã‚‹ãŸã‚ã« `NEW_VERSION` å¤‰æ•°ã‚’ `v$(shell rye version)` ã®ã‚ˆã†ã«å®šç¾©ã—ã¦ã„ã¾ã™ã€‚

##### Step1ã§ã®ç¢ºèªç‚¹

Step1ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ `release-step1` ãŒå®Œäº†ã™ã‚‹ã¨ã€ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒä½œæˆã•ã‚Œã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ç”Ÿæˆã•ã‚ŒãŸCHANGELOGã‚„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒWebä¸Šã§ç¢ºèªå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚ã•ã‚‰ã«ã€GitHub Actionsã§ãƒ†ã‚¹ãƒˆã‚’è¨­å®šã—ã¦ã„ã‚‹å ´åˆã€ã“ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ãƒ†ã‚¹ãƒˆã®æˆå¦ã‚‚ç¢ºèªã§ãã¾ã™ã€‚å•é¡ŒãŒãªã‘ã‚Œã°`release-step2`ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

##### `rye build`ã¨`dist`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª

`rye build` ã‚³ãƒãƒ³ãƒ‰ã¯ã€ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ `dist` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä½œæˆã—ã¾ã™ã€‚ã“ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯é€šå¸¸ã€Gitã®ç®¡ç†å¯¾è±¡å¤–ã¨ã•ã‚Œã‚‹ãŸã‚ã€ãƒªãƒã‚¸ãƒˆãƒªã«å«ã‚ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã“ã®Makefileã§ã¯ã€ãã®ã‚ˆã†ãªå‰æã«åŸºã¥ã„ã¦ `rye build` ã‚’ `release-step2` ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚


#### æœ€é©åŒ–ã—ãŸMakefile

```make
# Makefile for automating release tasks

# Get project name from pyproject.toml
PROJECT_NAME=$(shell grep name pyproject.toml | head -n 1 | awk -F= '{print $$2}' | xargs)
# Get the current version using `rye version`
NEW_VERSION=v$(shell rye version)

# Step 1: Create PR
release-step1: gen-docs gen-changelog commit create-pr

gen-docs:
	pdoc --html --output-dir=docs --force $(PROJECT_NAME)
	mv docs/$(PROJECT_NAME)/* docs
	rmdir docs/$(PROJECT_NAME)

gen-changelog:
	git cliff --tag $(NEW_VERSION) -o CHANGELOG.md

commit:
	git add --all
	git commit -m "chore: ğŸš€ new release setup $(NEW_VERSION)"

create-pr:
	gh pr create --title "$(PROJECT_NAME): New release $(NEW_VERSION)" --body "Release version $(NEW_VERSION)"
	gh pr list --json number,title | jq -r --arg title "$(PROJECT_NAME): New release $(NEW_VERSION)" 'map(select(.title == $$title)) | .[0].number' > pr_id.txt


# Step 2: Merge PR, tag, and cleanup
release-step2: merge-pr pull-main tag-version publish create-dev-branch

merge-pr:
	gh pr merge $(shell cat pr_id.txt) --merge --delete-branch

pull-main:
	@if [ -f pr_id.txt ]; then \
		echo "Removing pr_id.txt"; \
		rm pr_id.txt; \
	fi
	git checkout main
	git pull origin main

tag-version:
	git tag $(NEW_VERSION)
	git push origin $(NEW_VERSION)

publish:
	rye build -c && rye publish -y

create-dev-branch:
	$(eval NEW_DEV_BRANCH := dev-after-$(NEW_VERSION))
	git checkout -b $(NEW_DEV_BRANCH)

help:
	@echo "Available steps:"
	@echo "  release-step1: Change the version number of pyproject.toml and then run it."
	@echo "  release-step2: Check the contents of the PR and if there are no problems, execute it."
```

---

ã“ã®Makefileã¯ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒªãƒªãƒ¼ã‚¹ä½œæ¥­ã‚’åŠ¹ç‡çš„ã«è¡Œã†ãŸã‚ã®å¼·åŠ›ãªãƒ„ãƒ¼ãƒ«ã§ã™ã€‚å„ã‚¿ã‚¹ã‚¯ã¯æ˜ç¢ºã«åˆ†å‰²ã•ã‚Œã¦ãŠã‚Šã€`make help` ã‚³ãƒãƒ³ãƒ‰ã«ã‚ˆã£ã¦ç°¡å˜ãªä½¿ã„æ–¹ã‚‚ç¢ºèªã§ãã¾ã™ã€‚ã“ã®Makefileã‚’æ´»ç”¨ã™ã‚‹ã“ã¨ã§ã€æ‰‹ä½œæ¥­ã«ã‚ˆã‚‹ãƒŸã‚¹ã‚’æ¸›ã‚‰ã—ã€ä½œæ¥­ã®åŠ¹ç‡ã‚’å¤§å¹…ã«å‘ä¸Šã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
